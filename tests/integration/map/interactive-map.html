<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>インタラクティブ地図機能テスト</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .test-map {
            width: 100%;
            height: 500px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .test-btn {
            padding: 10px 20px;
            border: none;
            background: #4CAF50;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .test-btn:hover {
            background: #45a049;
        }
        
        .test-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .feature-list {
            list-style-type: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .feature-list li:before {
            content: "✓ ";
            color: #4CAF50;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>インタラクティブ地図機能テスト</h1>
            <p>Task 8: 地図のズーム・パン機能、国クリック情報表示、モバイルタッチジェスチャー対応</p>
        </div>
        
        <div class="test-info">
            <h3>実装された機能:</h3>
            <ul class="feature-list">
                <li>カスタムズーム・パンコントロール</li>
                <li>地図クリック時の国情報表示</li>
                <li>モバイルタッチジェスチャー対応</li>
                <li>画面回転・リサイズ対応</li>
                <li>長押しコンテキストメニュー（モバイル）</li>
                <li>ズームレベルに応じたマーカー調整</li>
            </ul>
        </div>
        
        <div class="test-controls">
            <button class="test-btn" onclick="initializeTestMap()">地図を初期化</button>
            <button class="test-btn" onclick="testCountryHighlight()">国をハイライト</button>
            <button class="test-btn" onclick="testZoomControls()">ズーム機能テスト</button>
            <button class="test-btn" onclick="testPanControls()">パン機能テスト</button>
            <button class="test-btn" onclick="testMobileFeatures()">モバイル機能テスト</button>
            <button class="test-btn" onclick="resetTestMap()">地図リセット</button>
        </div>
        
        <div id="test-map" class="test-map"></div>
        
        <div class="test-info">
            <h3>テスト手順:</h3>
            <ol>
                <li><strong>地図を初期化</strong>ボタンをクリックして地図を表示</li>
                <li>地図上の任意の場所をクリックして国情報を確認</li>
                <li>右上のカスタムズームコントロールを使用</li>
                <li>左上のカスタムパンコントロールを使用</li>
                <li>マウスホイールでズーム、ドラッグでパンを確認</li>
                <li>モバイルデバイスでタッチジェスチャーを確認</li>
                <li>画面サイズを変更して応答性を確認</li>
            </ol>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Custom JavaScript -->
    <script src="../../../js/countryService.js"></script>
    <script src="../../../js/map.js"></script>
    
    <script>
        // Test-specific variables
        let testMap = null;
        let testCountries = [];
        
        // Mock game state for testing
        window.gameState = {
            currentCountry: {
                name: { common: "Japan" },
                flag: "🇯🇵",
                capital: ["Tokyo"],
                region: "Asia",
                subregion: "Eastern Asia",
                population: 125836021,
                area: 377930,
                latlng: [36.0, 138.0]
            }
        };
        
        // Mock countries data for testing
        window.allCountries = [
            {
                name: { common: "Japan" },
                flag: "🇯🇵",
                capital: ["Tokyo"],
                region: "Asia",
                subregion: "Eastern Asia",
                population: 125836021,
                area: 377930,
                latlng: [36.0, 138.0]
            },
            {
                name: { common: "United States" },
                flag: "🇺🇸",
                capital: ["Washington, D.C."],
                region: "Americas",
                subregion: "North America",
                population: 331002651,
                area: 9833517,
                latlng: [38.0, -97.0]
            },
            {
                name: { common: "France" },
                flag: "🇫🇷",
                capital: ["Paris"],
                region: "Europe",
                subregion: "Western Europe",
                population: 67391582,
                area: 551695,
                latlng: [46.0, 2.0]
            },
            {
                name: { common: "Australia" },
                flag: "🇦🇺",
                capital: ["Canberra"],
                region: "Oceania",
                subregion: "Australia and New Zealand",
                population: 25499884,
                area: 7692024,
                latlng: [-27.0, 133.0]
            }
        ];
        
        function initializeTestMap() {
            // Override map container ID for testing
            const originalMapId = 'world-map';
            const testMapId = 'test-map';
            
            // Temporarily change the map initialization to use test container
            const originalInit = initializeMap;
            window.initializeMap = function() {
                try {
                    const mapContainer = document.getElementById(testMapId);
                    if (!mapContainer) {
                        console.error('Test map container not found');
                        return false;
                    }

                    // Initialize Leaflet map with enhanced mobile support
                    map = L.map(testMapId, {
                        center: MAP_CONFIG.center,
                        zoom: MAP_CONFIG.zoom,
                        minZoom: MAP_CONFIG.minZoom,
                        maxZoom: MAP_CONFIG.maxZoom,
                        zoomControl: MAP_CONFIG.zoomControl,
                        scrollWheelZoom: MAP_CONFIG.scrollWheelZoom,
                        touchZoom: MAP_CONFIG.touchZoom,
                        doubleClickZoom: MAP_CONFIG.doubleClickZoom,
                        boxZoom: MAP_CONFIG.boxZoom,
                        keyboard: MAP_CONFIG.keyboard,
                        dragging: MAP_CONFIG.dragging,
                        tap: MAP_CONFIG.tap,
                        tapTolerance: MAP_CONFIG.tapTolerance,
                        bounceAtZoomLimits: MAP_CONFIG.bounceAtZoomLimits
                    });

                    // Add tile layer
                    L.tileLayer(TILE_LAYER.url, {
                        attribution: TILE_LAYER.attribution,
                        maxZoom: TILE_LAYER.maxZoom
                    }).addTo(map);

                    // Set up map interactions
                    setupMapInteractions();
                    
                    // Enable mobile touch gestures
                    enableMobileTouchGestures();

                    console.log('Test map initialized successfully');
                    return true;
                    
                } catch (error) {
                    console.error('Error initializing test map:', error);
                    return false;
                }
            };
            
            // Initialize the test map
            const success = initializeMap();
            
            if (success) {
                alert('地図が正常に初期化されました！\n\n地図をクリックして国情報を表示したり、カスタムコントロールを使用してみてください。');
            } else {
                alert('地図の初期化に失敗しました。');
            }
        }
        
        function testCountryHighlight() {
            if (!map) {
                alert('まず地図を初期化してください。');
                return;
            }
            
            const testCountry = window.allCountries[0]; // Japan
            const coordinates = getCountryCoordinates(testCountry);
            
            if (coordinates) {
                highlightCountry('JP', coordinates);
                alert('日本がハイライトされました！地図上のマーカーをクリックして詳細情報を確認してください。');
            } else {
                alert('国の座標が見つかりません。');
            }
        }
        
        function testZoomControls() {
            if (!map) {
                alert('まず地図を初期化してください。');
                return;
            }
            
            alert('ズーム機能をテストします：\n\n1. 右上のカスタムズームコントロール（+、−、🌍）を使用\n2. マウスホイールでズーム\n3. ダブルクリックでズームイン');
        }
        
        function testPanControls() {
            if (!map) {
                alert('まず地図を初期化してください。');
                return;
            }
            
            alert('パン機能をテストします：\n\n1. 左上のカスタムパンコントロール（矢印、⌂）を使用\n2. 地図をドラッグして移動\n3. ⌂ボタンで中央に戻る');
        }
        
        function testMobileFeatures() {
            if (!map) {
                alert('まず地図を初期化してください。');
                return;
            }
            
            alert('モバイル機能をテストします：\n\n1. タッチでドラッグ（パン）\n2. ピンチでズーム\n3. 長押しでコンテキストメニュー\n4. 画面回転で自動調整');
        }
        
        function resetTestMap() {
            if (!map) {
                alert('まず地図を初期化してください。');
                return;
            }
            
            resetMapView();
            alert('地図がリセットされました！');
        }
    </script>
</body>
</html>